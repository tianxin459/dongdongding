<style lang="less">
@import '../theme.less';
// @import '../buttons.less';

.container {
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.body {
  color: white;
}

.title {
  width: 100%;
  font-weight: 200;
}

.input-container {
  width: 100%;
}

.ratio {
  border-bottom: 2px solid green;
}

.input {
  // border: 1px solid green;
  width: 100%;
  .input-label {
  }
  input {
    // border: 1px solid green;
    height: 4ex;
    border-bottom: 2px solid green;
  }
}
.button-circle {
  margin: 40rpx;
}

.btn-normal {
  width: 80%;
  margin: 40rpx;
}

.btnStart {
  position: fixed;
  top: 100px;
  right: 25px;
  background-color: red;
  color: white;
}

@keyframes runnerHead {
  from {
    top: 12.5px;
  }
  80% {
    top: 16px;
  }
  to {
    top: 12.5px;
  }
}
.avatar {
  width: 100%;
  height: 150px;
}

.runner {
  position: relative;
  transition: all linear 0.1s;
  margin-left: -50px;
  left: 50%;
  .running-head {
    position: absolute;
    width: 100px;
    height: 100px;
    border: 1px solid green;
    box-shadow: 0 0 0 1px white;
    border-radius: 50%;
    animation-name: runnerHead;
    animation-duration: 0.4s;
    animation-iteration-count: infinite;
    left: 30px;
  }
  .running-body {
    position: absolute;
    top: 50px;
    left: -70px;
    width: 200px;
    height: 150px;
  }
}

.display {
  font-size: 30px;
  .ranking {
    max-width: 100vw;
    color: orange;
    // text-shadow: 0 0 1px currentColor, -1px -1px 1px #030, 0 -1px 1px #030,
    //   1px -1px 1px #030, 1px 0 1px #030, 1px 1px 1px #030, 0 1px 1px #030,
    //   -1px 1px 1px #030, -1px 0 1px #030;
  }
}
.scanCover {
  display: flex;
  justify-content: center;
  align-items: center;
  position: fixed;
  top: 0px;
  left: 0px;
  background: gray;
  width: 100%;
  height: 100%;
  &.hideQR {
    animation: ani-hide 1s ease forwards;
  }
}
@keyframes ani-hide {
  0% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-20%);
  }
  100% {
    transform: translateY(-100%);
  }
}
</style>
<template>
  <view class="container">
    <header></header>
    <view class="body">
      <view>
        <view>{{Lang.shake.Url}}</view>
        {{Lang.shake.Desc1}}
        <view>
          Msg:{{msg}}
        </view>
        <button class="btn-normal button button-3d button-caution" @tap="onStart" wx:if="{{true||isAdmin}}">
          <text>{{Lang.shake.BtnStart}}</text>
        </button>
        <button class="btn-normal button button-3d button-caution" @tap="testRun" wx:if="{{isAdmin}}">
          <text>test run</text>
        </button>
      </view>
      <view class="avatar">
        <view class="runner">
          <!-- <image class="running-body" src='https://ellist.cn/wmtan/static/img/running1.gif'></image> -->
          <image class="running-body" src='../static/img/Bus1.gif'></image>
          <image class="running-head" src="{{UserInfo.avatarUrl}}"></image>
        </view>
      </view>
      <view class="display">
        <view class="ranking">
          {{ranking}}
        </view>
      </view>

      <button class="button button-raised button-action button-circle" @tap="onShake" wx:if="{{showButton}}">
        <text>{{Lang.shake.BtnReady}}</text>
      </button>
    </view>
    <view class="scanCover {{showQRScan?'':'hideQR'}}">
      <!-- <image class="btn-img" src='../static/icon/scan.png'></image> -->
      <button class="button button-highlight button-raised button-action button-circle" @tap="scanQR">
        <image class="btn-img" src='../static/icon/scan.png'></image>
      </button>
    </view>
  </view>
</template>
<script>
import wepy from 'wepy';
import Header from '@/components/header'; // alias example
import TextMixin from '@/mixins/text';
// import { $wuxBackdrop } from '../wux/index'
export default class ShakeGroup extends wepy.page {
  components = {
    header: Header
  };
  mixins = [TextMixin];
  config = {
    usingComponents: {}
  };
  computed = {
    UserInfo() {
      return this.$parent.globalData.userInfo;
    },
    isAdmin() {
      return this.$parent.isAdmin();
    }
  };
  components = {};
  data = {
    lastCheckTime: 0,
    threshold: 2,
    checkTimeThreshold: 1000,
    requestTimeBreak: 1000,
    hits: [],
    shakeHistory: [],
    amp: 1,
    sx: 0,
    sy: 0,
    sz: 0,
    msg: '',
    range: 1,
    showButton: true,
    showQRScan: false,
    ranking: 'Click to ready',
    shakeActive: true,
    shakeSteps: 0,
    groupid: 0
  };
  methods = {
    testRun(e) {
      this.sendRun(50);
      console.log('send test run 50');
    },
    scanQR() {
      let self = this;
      self.showQRScan = false;
      return;
      wepy.scanCode({
        success: function(resp) {
          self.msg = resp.result;
          self.showQRScan = false;
        },
        fail: console.error
      });
    },
    onStart(e) {
      let url = 'https://ellist.cn/wmtan/api/race/begin';
      let dataRun = {
        Message: 'GoGoGo'
      };
      wepy.request({
        url: url,
        method: 'POST',
        data: dataRun,
        success: function(resp) {
          console.log('start Run send', resp);
        },
        fail: function(err) {
          console.error(err);
        }
      });
    },
    onEmailChange(e) {
      this.email = e.detail.value;
    },
    onEnglishNameChange(e) {
      this.englishName = e.detail.value;
    },
    onNumPeopleChange(e) {
      this.numPeople = e.detail.value;
      console.log(e.detail.value);
    },
    submit() {
      console.log('start shake');
      // this.shakeFun();
      // this.sendRun();
    },
    onShake() {
      let self = this;
      self.showButton = false;
      self.ranking = self.Lang.shake.WaitSignal; //'Wait for Start Signal...';
      this.startShake();
      this.sendRun();
      this.sendRun(10);
      self.$apply();
    }
  };
  onAccelerometerChange(res) {
    let self = this;

    self.sx = res.x;
    self.sy = res.y;
    self.sz = res.z;
    var x = res.x.toFixed(4);
    var y = res.y.toFixed(4);
    var z = res.z.toFixed(4);
    if (
      res.x > self.threshold ||
      res.y > self.threshold ||
      res.z > self.threshold
    ) {
      self.shakeHistory.push({ x, y, z });
    }
    let nowCheckTime = Date.now();
    if (nowCheckTime - self.lastCheckTime < self.checkTimeThreshold) return;
    self.lastCheckTime = nowCheckTime;
    if (self.shakeHistory.length < 1) return;

    let maxx = Math.max(...self.shakeHistory.map(i => Math.abs(i.x)));
    let maxy = Math.max(...self.shakeHistory.map(i => Math.abs(i.y)));
    let maxz = Math.max(...self.shakeHistory.map(i => Math.abs(i.z)));
    let run = Math.ceil(maxx + maxy + maxz);
    let count = self.shakeHistory.length;
    self.shakeHistory.length = 0;
    let hit = { x: maxx, y: maxy, z: maxz, run: run, count };
    self.hits.push(hit);
    let runDis = hit.run * self.amp;

    if (self.shakeActive) {
      self.sendRun(runDis);
      self.msg = runDis;
      self.ranking = 'run for ' + runDis;
    }
    self.$apply();
  }
  shakeFun() {
    // shake
    var self = this;
    // var positivenum = 0;
    wx.startAccelerometer({
      interval: 'ui'
    });
    // self.ranking = 'Wait for Start Signal...';
    // wx.onAccelerometerChange(onAccelerometerChange);
    self.$apply();
  }

  sendRun(step) {
    let url = 'https://ellist.cn/wmtan/api/race/run';
    let self = this;
    let dataRun = {
      userId: this.$parent.globalData.userInfo.openid,
      englishName: this.$parent.globalData.user.englishName,
      avatorUrl: this.$parent.globalData.userInfo.avatarUrl,
      gender: this.$parent.globalData.userInfo.gender,
      message: step
    };
    let header = {
      groupId: self.groupid
    };
    console.log('dataRun', dataRun);
    this.$parent.wxRequest({
      url: url,
      method: 'POST',
      data: dataRun,
      header: header,
      success: function(resp) {
        self.msg = 'run ' + step;
        console.log('dataRun send', resp);
      },
      fail: function(err) {
        console.error(err);
      }
    });
  }
  onUnload() {
    wx.stopAccelerometer();
  }
  onLoad(parm, data) {
    let self = this;
    self.showButton = true;
    // this.shakeActive = true
  }
  onHide() {
    let self = this;
    self.showButton = true;
    self.ranking = '';
    wx.stopAccelerometer();
    // self.$apply();
  }
  onShow() {
    let self = this;
    self.ranking = self.Lang.shake.ClickReady;
    if (self.shakeActive) {
      this.startShake();
    }
    this.$parent.getConfig(false, config => {
      self.config = config;
    });
  }
  startShake() {
    this.shakeActive = true;
    wx.startAccelerometer({
      interval: 'ui'
    });
    wepy.vibrateLong();
  }
  onSocketMessage(res) {
    let self = this;
    console.log('shake=>wsresponse', res);
    // 接收消息回调
    var data = JSON.parse(res.data.replace(String.fromCharCode(0x1e), '')); // 返回时去掉分隔符
    if (data.target) {
      switch (data.target) {
        case 'ReceiveMessage':
          self.msg = data.arguments[0] + '|' + data.arguments[1];
          self.ReceiveMessage(data.arguments[0], data.arguments[1]);
          break;
        default:
          break;
      }
      self.$apply();
    }
  }
  ReceiveMessage(uid, message) {
    let self = this;
    if (!message) return;
    if (message.indexOf('finish at') > -1) {
      self.shakeActive = false;
      wepy.vibrateLong();
      self.ranking = 'Competition ranking:' + message.replace('finish at', '');
      wx.stopAccelerometer();
    }
    if (message.indexOf('GoGoGo') > -1) {
      self.startShake();
      // self.shakeActive = true;
      // wepy.vibrateLong();
      self.ranking = 'Go! Shake~Shake';
    }
  }
}
</script>
